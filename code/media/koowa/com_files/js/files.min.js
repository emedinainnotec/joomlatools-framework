(function(t,e){if(!t.Koowa)t.Koowa={};if(typeof exports=="object")module.exports=e();else if(typeof define=="function"&&define.amd)define(e);else t.Koowa.Spinner=e()})(this,function(){"use strict";var t=["webkit","Moz","ms","O"],e={},i;function o(t,e){var i=document.createElement(t||"div"),o;for(o in e)i[o]=e[o];return i}function n(t){for(var e=1,i=arguments.length;e<i;e++)t.appendChild(arguments[e]);return t}var r=function(){var t=o("style",{type:"text/css"});n(document.getElementsByTagName("head")[0],t);return t.sheet||t.styleSheet}();function s(t,o,n,s){var a=["opacity",o,~~(t*100),n,s].join("-"),f=.01+n/s*100,l=Math.max(1-(1-t)/o*(100-f),t),u=i.substring(0,i.indexOf("Animation")).toLowerCase(),d=u&&"-"+u+"-"||"";if(!e[a]){r.insertRule("@"+d+"keyframes "+a+"{"+"0%{opacity:"+l+"}"+f+"%{opacity:"+t+"}"+(f+.01)+"%{opacity:1}"+(f+o)%100+"%{opacity:"+t+"}"+"100%{opacity:"+l+"}"+"}",r.cssRules.length);e[a]=1}return a}function a(e,i){var o=e.style,n,r;i=i.charAt(0).toUpperCase()+i.slice(1);for(r=0;r<t.length;r++){n=t[r]+i;if(o[n]!==undefined)return n}if(o[i]!==undefined)return i}function f(t,e){for(var i in e)t.style[a(t,i)||i]=e[i];return t}function l(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var o in i)if(t[o]===undefined)t[o]=i[o]}return t}function u(t){var e={x:t.offsetLeft,y:t.offsetTop};while(t=t.offsetParent)e.x+=t.offsetLeft,e.y+=t.offsetTop;return e}function d(t,e){return typeof t=="string"?t:t[e%t.length]}var p={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:1/4,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};function c(t){if(typeof this=="undefined")return new c(t);this.opts=l(t||{},c.defaults,p)}c.defaults={};l(c.prototype,{spin:function(t){this.stop();var e=this,n=e.opts,r=e.el=f(o(0,{className:n.className}),{position:n.position,width:0,zIndex:n.zIndex}),s=n.radius+n.length+n.width,a,l;if(t){t.insertBefore(r,t.firstChild||null);l=u(t);a=u(r);f(r,{left:(n.left=="auto"?l.x-a.x+(t.offsetWidth>>1):parseInt(n.left,10)+s)+"px",top:(n.top=="auto"?l.y-a.y+(t.offsetHeight>>1):parseInt(n.top,10)+s)+"px"})}r.setAttribute("role","progressbar");e.lines(r,e.opts);if(!i){var d=0,p=(n.lines-1)*(1-n.direction)/2,c,h=n.fps,m=h/n.speed,y=(1-n.opacity)/(m*n.trail/100),g=m/n.lines;(function v(){d++;for(var t=0;t<n.lines;t++){c=Math.max(1-(d+(n.lines-t)*g)%m*y,n.opacity);e.opacity(r,t*n.direction+p,c,n)}e.timeout=e.el&&setTimeout(v,~~(1e3/h))})()}return e},stop:function(){var t=this.el;if(t){clearTimeout(this.timeout);if(t.parentNode)t.parentNode.removeChild(t);this.el=undefined}return this},lines:function(t,e){var r=0,a=(e.lines-1)*(1-e.direction)/2,l;function u(t,i){return f(o(),{position:"absolute",width:e.length+e.width+"px",height:e.width+"px",background:t,boxShadow:i,transformOrigin:"left",transform:"rotate("+~~(360/e.lines*r+e.rotate)+"deg) translate("+e.radius+"px"+",0)",borderRadius:(e.corners*e.width>>1)+"px"})}for(;r<e.lines;r++){l=f(o(),{position:"absolute",top:1+~(e.width/2)+"px",transform:e.hwaccel?"translate3d(0,0,0)":"",opacity:e.opacity,animation:i&&s(e.opacity,e.trail,a+r*e.direction,e.lines)+" "+1/e.speed+"s linear infinite"});if(e.shadow)n(l,f(u("#000","0 0 4px "+"#000"),{top:2+"px"}));n(t,n(l,u(d(e.color,r),"0 0 1px rgba(0,0,0,.1)")))}return t},opacity:function(t,e,i){if(e<t.childNodes.length)t.childNodes[e].style.opacity=i}});function h(){function t(t,e){return o("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',e)}r.addRule(".spin-vml","behavior:url(#default#VML)");c.prototype.lines=function(e,i){var o=i.length+i.width,r=2*o;function s(){return f(t("group",{coordsize:r+" "+r,coordorigin:-o+" "+-o}),{width:r,height:r})}var a=-(i.width+i.length)*2+"px",l=f(s(),{position:"absolute",top:a,left:a}),u;function p(e,r,a){n(l,n(f(s(),{rotation:360/i.lines*e+"deg",left:~~r}),n(f(t("roundrect",{arcsize:i.corners}),{width:o,height:i.width,left:i.radius,top:-i.width>>1,filter:a}),t("fill",{color:d(i.color,e),opacity:i.opacity}),t("stroke",{opacity:0}))))}if(i.shadow)for(u=1;u<=i.lines;u++)p(u,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(u=1;u<=i.lines;u++)p(u);return n(e,l)};c.prototype.opacity=function(t,e,i,o){var n=t.firstChild;o=o.shadow&&o.lines||0;if(n&&e+o<n.childNodes.length){n=n.childNodes[e+o];n=n&&n.firstChild;n=n&&n.firstChild;if(n)n.opacity=i}}}var m=f(o("group"),{behavior:"url(#default#VML)"});if(!a(m,"transform")&&m.adj)h();else i=a(m,"animation");return c});if(!Files)var Files={};if(!Files._){Files._=function(string){return string}}if(!Files.utils){Files.utils={append:function(a,b){if(window.$extend)return $extend(a,b);else return Object.append(a,b)},typeOf:function(subject){if(window.$type)return $type(subject);else return typeOf(subject)},merge:function(a,b){if(window.$merge)return $merge(a,b);else{var i=Array.slice(arguments);i.unshift({});return Object.merge.apply(null,i)}},each:function(a,b,c){if(window.$each)return $each(a,b,c);else return Object.each(a,b,c)}}}Files.Filesize=new Class({Implements:Options,options:{units:["Bytes","KB","MB","GB","TB","PB"]},initialize:function(size,options){this.setOptions(options);this.size=size},humanize:function(){var i=0,size=this.size;while(size>=1024){size/=1024;i++}return(i===0||size%1===0?size:size.toFixed(2))+" "+Files._(this.options.units[i])}});Files.FileTypes={};Files.FileTypes.map={audio:["aif","aiff","alac","amr","flac","ogg","m3u","m4a","mid","mp3","mpa","wav","wma"],video:["3gp","avi","flv","mkv","mov","mp4","mpg","mpeg","rm","swf","vob","wmv"],image:["bmp","gif","jpg","jpeg","png","psd","tif","tiff"],document:["doc","docx","rtf","txt","xls","xlsx","pdf","ppt","pptx","pps","xml"],archive:["7z","gz","rar","tar","zip"]};Files.getFileType=function(extension){var type="document";extension=extension.toLowerCase();Files.utils.each(Files.FileTypes.map,function(value,key){if(value.contains(extension)){type=key}});return type};if(!Files)var Files={};Files.State=new Class({Implements:Options,data:{},defaults:{},options:{defaults:{}},initialize:function(options){this.setOptions(options);if(this.options.data){Files.utils.append(this.data,this.options.data)}if(this.options.defaults){Files.utils.append(this.defaults,this.options.defaults);Files.utils.append(this.data,this.defaults)}},getData:function(){return this.data},setDefaults:function(){this.set(this.defaults);return this},set:function(key,value){if(Files.utils.typeOf(key)=="object"){Files.utils.append(this.data,key)}else{this.data[key]=value}return this},get:function(key,def){return this.data[key]||def},unset:function(key){delete this.data[key]}});if(!Files)var Files={};(function(){var cache={};Files.Template=new Class({Implements:[Events],render:function(layout){var tmpl=this.template;layout=layout||"default";if(layout!=="default"){tmpl=layout+"_"+tmpl}this.fireEvent("beforeRender",{layout:layout,template:tmpl});var rendered=new EJS({element:tmpl}).render(this),result=new(Files.Template[layout.capitalize()])(rendered);this.fireEvent("afterRender",{layout:layout,template:tmpl,result:result});return result}});Files.Template.Details=new Class({initialize:function(html){var el=new Element("div",{html:html}).getElement("table");if(el){return el}else{var str="<table><tbody>"+html+"</tbody></table>";return new Element("div",{html:str}).getElement("tr")}}});Files.Template.Default=new Class({initialize:function(html){return new Element("div",{html:html}).getFirst()}});Files.Template.Icons=new Class({initialize:function(html){return new Element("div",{html:html}).getFirst()}});Files.Template.Compact=new Class({initialize:function(html){return new Element("div",{html:html}).getFirst()}})})();if(!Files)var Files={};Files.Grid=new Class({Implements:[Events,Options],layout:"icons",options:{onClickFolder:function(){},onClickFile:function(){},onClickImage:function(){},onDeleteNode:function(){},onSwitchLayout:function(){},switchers:".files-layout-switcher",layout:false,batch_delete:false,icon_size:150,types:null},initialize:function(container,options){this.setOptions(options);this.addEvents({afterReset:function(){this.spin()},afterInsertRows:function(){this.unspin()}});this.nodes=new Hash;this.container=document.id(container);if(this.options.switchers){this.options.switchers=document.getElements(this.options.switchers)}if(this.options.batch_delete){this.options.batch_delete=document.getElement(this.options.batch_delete)}if(this.options.layout){this.setLayout(this.options.layout)}this.render();this.attachEvents()},attachEvents:function(){var that=this,createEvent=function(selector,event_name){that.container.addEvent(selector,function(e){e.stop();that.fireEvent(event_name,arguments)})};createEvent("click:relay(.files-folder a.navigate)","clickFolder");createEvent("click:relay(.files-file a.navigate)","clickFile");createEvent("click:relay(.files-image a.navigate)","clickImage");var fireCheck=function(e){if(e.target.match("a.navigate")){return}if(e.target.get("tag")=="input"){e.target.setProperty("checked",!e.target.getProperty("checked"))}var box=e.target.getParent(".files-node-shadow");if(!box){box=e.target.match(".files-node")?e.target:e.target.getParent(".files-node")}that.checkNode(box.retrieve("row"))};this.container.addEvent("click:relay(div.imgOutline)",fireCheck.bind(this));this.container.addEvent("click:relay(input.files-select)",fireCheck.bind(this));var deleteEvt=function(e){if(e.stop){e.stop()}var box=e.target.getParent(".files-node-shadow");if(!box){box=e.target.match(".files-node")?e.target:e.target.getParent(".files-node")}this.erase(box.retrieve("row").path)}.bind(this);this.container.addEvent("click:relay(.delete-node)",deleteEvt);that.addEvent("afterDeleteNodeFail",function(context){var xhr=context.xhr,response=JSON.decode(xhr.responseText,true);if(response&&response.error){alert(response.error)}});if(this.options.batch_delete){var chain=new Chain,chain_call=function(){chain.callChain()},that=this;this.addEvent("afterCheckNode",function(){var checked=this.container.getElements("input[type=checkbox]:checked");this.options.batch_delete.setProperty("disabled",!checked.length)}.bind(this));this.options.batch_delete.addEvent("click",function(e){e.stop();var file_count=0,files=[];folder_count=0,folders=[],checkboxes=this.container.getElements("input[type=checkbox]:checked.files-select").filter(function(el){if(el.checked){var box=el.getParent(".files-node-shadow")||el.getParent(".files-node"),name=box.retrieve("row").name;if(el.getParent(".files-node").hasClass("files-folder")){folder_count++;folders.push(name)}else{file_count++;files.push(name)}return true}});var message="";if(file_count+folder_count===1){message=Files._("You are deleting {item}. Are you sure?");message=message.replace("{item}",folder_count?folders[0]:files[0])}else{var count=file_count+folder_count,message=Files._("You are deleting {items}. Are you sure?"),items=Files._("{count} files and folders");if(!folder_count&&file_count){items=Files._("{count} files")}else if(folder_count&&!file_count){items=Files._("{count} folders")}items=items.replace("{count}",count);message=message.replace("{items}",items)}if(!checkboxes.length||!confirm(message)){return false}that.addEvent("afterDeleteNode",chain_call);that.addEvent("afterDeleteNodeFail",chain_call);checkboxes.each(function(el){if(!el.checked){return}chain.chain(function(){deleteEvt({target:el})})});chain.chain(function(){that.removeEvent("afterDeleteNode",chain_call);that.removeEvent("afterDeleteNodeFail",chain_call);chain.clearChain()});chain.callChain()}.bind(this))}if(this.options.switchers){var that=this;this.options.switchers.addEvent("click",function(e){e.stop();var layout=this.get("data-layout");that.setLayout(layout);that._updateSwitchers(layout)})}if(this.options.icon_size){var size=this.options.icon_size;this.addEvent("beforeRenderObject",function(context){context.object.icon_size=size})}},checkNode:function(row,fire_events){var box=row.element,node=row.element.match(".files-node")?row.element:row.element.getElement(".files-node"),checkbox=box.getElement("input[type=checkbox]");if(fire_events!==false){this.fireEvent("beforeCheckNode",{row:row,checkbox:checkbox})}var old=checkbox.getProperty("checked");!old?node.addClass("selected"):node.removeClass("selected");row.checked=!old;checkbox.setProperty("checked",!old);if(fire_events!==false){this.fireEvent("afterCheckNode",{row:row,checkbox:checkbox})}},erase:function(node){if(typeof node==="string"){node=this.nodes.get(node)}if(node){this.fireEvent("beforeDeleteNode",{node:node});var success=function(){if(node.element){node.element.dispose()}this.nodes.erase(node.path);this.fireEvent("afterDeleteNode",{node:node})}.bind(this),failure=function(xhr){this.fireEvent("afterDeleteNodeFail",{node:node,xhr:xhr})}.bind(this);node["delete"](success,failure)}},render:function(){this.fireEvent("beforeRender");this.container.empty();this.root=new Files.Grid.Root(this.layout);this.container.adopt(this.root.element);this.renew();this.fireEvent("afterRender")},renderObject:function(object,position){var position=position||"alphabetical";this.fireEvent("beforeRenderObject",{object:object,position:position});object.element=object.render(this.layout);object.element.store("row",object);if(position=="last"){this.root.adopt(object.element,"bottom")}else if(position=="first"){this.root.adopt(object.element)}else{var index=this.nodes.filter(function(node){return node.type==object.type}).getKeys();if(index.length===0){if(object.type==="folder"){var keys=this.nodes.getKeys();if(keys.length){var target=this.nodes.get(keys[0]);object.element.inject(target.element,"before")}else{this.root.adopt(object.element,"bottom")}}else{this.root.adopt(object.element,"bottom")}}else{index.push(object.path);index=index.sort();var obj_index=index.indexOf(object.path);var length=index.length;if(obj_index===0){var target=this.nodes.get(index[1]);object.element.inject(target.element,"before")}else{var target=obj_index+1===length?index[length-2]:index[obj_index-1];target=this.nodes.get(target);object.element.inject(target.element,"after")}}}this.fireEvent("afterRenderObject",{object:object,position:position});return object.element},reset:function(){this.fireEvent("beforeReset");this.nodes.each(function(node){if(node.element){node.element.dispose()}this.nodes.erase(node.path)}.bind(this));this.fireEvent("afterReset")},insert:function(object,position){this.fireEvent("beforeInsertNode",{object:object,position:position});if(!this.options.types||this.options.types.contains(object.type)){this.renderObject(object,position);this.nodes.set(object.path,object);this.fireEvent("afterInsertNode",{node:object,position:position})}},insertRows:function(rows){this.fireEvent("beforeInsertRows",{rows:rows});Files.utils.each(rows,function(row){var cls=Files[row.type.capitalize()];var item=new cls(row);this.insert(item,"last")}.bind(this));if(this.options.icon_size){this.setIconSize(this.options.icon_size)}this.fireEvent("afterInsertRows",{rows:rows})},renew:function(){this.fireEvent("beforeRenew");var folders=this.getFolders(),files=this.getFiles(),that=this,renew=function(node){var node=that.nodes.get(node);if(node.element){node.element.dispose()}that.renderObject(node,"last");if(node.checked){that.checkNode(node,false)}};folders.each(renew);files.each(renew);this.fireEvent("afterRenew")},setLayout:function(layout){if(layout){this.fireEvent("beforeSetLayout",{layout:layout});this.layout=layout;if(this.options.switchers){this._updateSwitchers(layout)}this.fireEvent("afterSetLayout",{layout:layout});this.render()}},getFolders:function(){return this.nodes.filter(function(node){return node.type==="folder"}).getKeys().sort()},getFiles:function(){return this.nodes.filter(function(node){return node.type==="file"||node.type=="image"}).getKeys().sort()},setIconSize:function(size){this.fireEvent("beforeSetIconSize",{size:size});this.options.icon_size=size;if(this.nodes.getKeys().length&&this.layout=="icons"){this.container.getElements(".imgTotal").setStyles({width:size+"px",height:size*.75+"px"});this.container.getElements(".imgOutline .ellipsis").setStyle("width",size+"px")}this.fireEvent("afterSetIconSize",{size:size})},spin:function(){if(!this.spinner){var target=document.id("files-grid");var opts={lines:12,length:7,width:4,radius:10,color:"#666",speed:1,trail:60};this.spinner=new Koowa.Spinner(opts)}this.spinner.spin(target)},unspin:function(){if(this.spinner){this.spinner.stop();this.spinner=null}},_updateSwitchers:function(layout){this.options.switchers.removeClass("active").filter(function(el){return el.get("data-layout")==layout}).addClass("active")}});Files.Grid.Root=new Class({Implements:Files.Template,template:"container",initialize:function(layout){this.element=this.render(layout)},adopt:function(element,position){position=position||"top";var parent=this.element;if(this.element.get("tag")=="table"){parent=this.element.getElement("tbody")}if(!element.injectInside)element.injectInside=element.inject;element.injectInside(parent,position)}});if(!Files)var Files={};(function($){Files.Tree=Koowa.Tree.extend({getDefaults:function(){var self=this,defaults={autoOpen:0,onSelectNode:function(){},dataFilter:function(response){var data=response.entities,parse=function(item,parent){var path=parent&&parent.path?parent.path+"/":"";path+=item.name;item=$.extend(item,{id:path,path:path,url:"#"+path,type:"folder"});if(item.children){var children=[];Files.utils.each(item.children,function(child){children.push(parse(child,item))});item.children=children}return item};if(response.meta.total){Files.utils.each(data,function(item,key){parse(item)})}return self.parseData(data)}};return $.extend(true,{},this.supr(),defaults)},parseData:function(list){return[{label:this.options.root.text,url:"#",children:list}]},fromUrl:function(url){var self=this;this.tree("loadDataFromUrl",url,null,function(response){if(Files.app&&Files.app.hasOwnProperty("active"))self.selectPath(Files.app.active)})},selectPath:function(path){var node=this.tree("getNodeById",path);if(!node){var tree=this.tree("getTree");node=tree.children.length?tree.children[0]:null}this.tree("selectNode",node)},appendNode:function(row,parent){if(parent===undefined)parent=this.tree("getSelectedNode");if(parent===false)parent=this.tree("getTree").children[0];var node,data=$.extend(true,{},row,{path:row.id,url:"#"+row.id,type:"folder"});if(parent&&parent.children&&parent.children.length){var name=data.label.toLowerCase();if(parent.children[0].name.toLowerCase()>name){node=this.tree("addNodeBefore",data,parent.children[0])}else if(parent.children[parent.children.length-1].name.toLowerCase()<name){node=this.tree("appendNode",data,parent)}else{var i=0;while(parent.children[i].name.toLowerCase()<name){i++}node=this.tree("addNodeBefore",data,parent.children[i])}}else{node=this.tree("appendNode",data,parent)}this.tree("selectNode",node);return this},removeNode:function(path){var node=this.tree("getNodeById",path);if(node){this.tree("removeNode",node)}},attachHandlers:function(){this._attachHandlers();var options=this.options,self=this;this.element.bind({"tree.select":function(event){var element;if(event.node){element=$(event.node.element);self.tree("openNode",event.node);options.onSelectNode(event.node)}if(event.node&&!event.node.hasOwnProperty("is_open")&&event.node.getLevel()===2){self.scrollIntoView(event.node,self.element,300)}},"tree.open":function(event){self.scrollIntoView(event.node,self.element,300)}});this.element.on("tree.select",function(){self.element.one("resize",function(){if(self.tree("getSelectedNode")){self.scrollIntoView(self.tree("getSelectedNode"),self.element,900)}})})}})})(window.jQuery);if(!Files)var Files={};Files.Row=new Class({Implements:[Options,Events,Files.Template],initialize:function(object,options){this.setOptions(options);Files.utils.each(object,function(value,key){this[key]=value}.bind(this));if(!this.path){this.path=(object.folder?object.folder+"/":"")+object.name}this.identifier=this.path;this.filepath=(object.folder?this.encodePath(object.folder)+"/":"")+this.encode(object.name)},encodePath:function(path,encoder){var parts=path.split("/");if(!encoder){encoder=this.encode}parts=parts.map(function(part){return encoder(part)});return parts.join("/")},encode:function(string){return string},realpath:function(string){return string}});Files.File=new Class({Extends:Files.Row,type:"file",template:"file",initialize:function(object,options){this.parent(object,options);if(Files.app){this.baseurl=Files.app.baseurl}this.size=new Files.Filesize(this.metadata.size);this.filetype=Files.getFileType(this.metadata.extension)},getModifiedDate:function(formatted){var date=new Date;date.setTime(this.metadata.modified_date*1e3);if(formatted){return date.toLocaleString()}else{return date}},"delete":function(success,failure){this.fireEvent("beforeDeleteRow");var that=this,request=new Request.JSON({url:Files.app.createRoute({view:"file",folder:that.folder,name:that.name}),method:"post",data:{action:"delete",_token:Files.token},onSuccess:function(response,responseText){if(typeof success=="function"){success(response)}that.fireEvent("afterDeleteRow",{status:true,response:response,request:this})},onFailure:function(xhr){if(xhr.status==204||xhr.status==1223){return this.onSuccess()}response=xhr.responseText;if(typeof failure=="function"){failure(xhr)}else{response=JSON.decode(xhr.responseText,true);error=response&&response.error?response.error:Files._("An error occurred during request");alert(error)}that.fireEvent("afterDeleteRow",{status:false,response:response,request:this,xhr:xhr})}});request.send()}});Files.Image=new Class({Extends:Files.File,type:"image",template:"image",initialize:function(object,options){this.parent(object,options);this.image=this.baseurl+"/"+this.encodePath(this.filepath,this.realpath);this.client_cache=false;if(window.sessionStorage){if(sessionStorage[this.image.toString()]){this.client_cache=sessionStorage[this.image.toString()]}}},getThumbnail:function(success,failure){var that=this,request=new Request.JSON({url:Files.app.createRoute({view:"thumbnail",filename:that.name,folder:that.folder}),method:"get",onSuccess:function(response,responseText){if(typeof success=="function"){success(response)}},onFailure:function(xhr){response=xhr.responseText;if(typeof failure=="function"){failure(xhr)}else{response=JSON.decode(xhr.responseText,true);error=response&&response.error?response.error:Files._("An error occurred during request");alert(error)}}});request.send()}});Files.Folder=new Class({Extends:Files.Row,type:"folder",template:"folder",getChildren:function(success,failure,extra_vars,url_builder){var path=this.path,url={view:"nodes",folder:path};if(extra_vars){url=Files.utils.append(url,extra_vars)}var url=url_builder?url_builder(url):Files.app.createRoute(url);Files.Folder.Request._onSuccess=success;Files.Folder.Request._onFailure=failure;Files.Folder.Request.options.url=url;Files.Folder.Request.get()},add:function(success,failure,complete){this.fireEvent("beforeAddRow");var that=this;request=new Request.JSON({url:Files.app.createRoute({view:"folder",name:that.name,folder:Files.app.getPath()}),method:"post",data:{action:"add",_token:Files.token},onSuccess:function(response,responseText){if(typeof success=="function"){success(response)}that.fireEvent("afterAddRow",{status:true,response:response,request:this})},onFailure:function(xhr){response=xhr.responseText;if(typeof failure=="function"){failure(xhr)}else{response=JSON.decode(xhr.responseText,true);error=response&&response.error?response.error:Files._("An error occurred during request");alert(error)}that.fireEvent("afterAddRow",{status:false,response:response,request:this,xhr:xhr})},onComplete:function(response){if(typeof complete=="function"){complete(response)}}});request.send()},"delete":function(success,failure){var that=this,request=new Request.JSON({url:Files.app.createRoute({view:"folder",folder:Files.app.getPath(),name:that.name}),method:"post",data:{action:"delete",_token:Files.token},onSuccess:function(response,responseText){if(typeof success=="function"){success(response)}that.fireEvent("afterDeleteRow",{status:true,response:response,request:this})},onFailure:function(xhr){if(xhr.status==204||xhr.status==1223){return this.onSuccess()}response=xhr.responseText;if(typeof failure=="function"){failure(xhr)}else{response=JSON.decode(xhr.responseText,true);error=response&&response.error?response.error:Files._("An error occurred during request");alert(error)}that.fireEvent("afterDeleteRow",{status:false,response:response,request:this,xhr:xhr})}});request.send()}});Files.Folder.Request=new Request.JSON({method:"get",onSuccess:function(response,responseText){if(typeof this._onSuccess=="function"){this._onSuccess(response)}},onFailure:function(xhr){if(typeof this._onFailure=="function"){this._onFailure(xhr)}else{resp=JSON.decode(xhr.responseText,true);error=resp&&resp.error?resp.error:Files._("An error occurred during request");alert(error)}}});Files.Paginator=new Class({Implements:[Options,Events],state:null,values:{total:0,limit:0,offset:0,page_total:0,page_current:0},initialize:function(element,options){if(options.state){this.state=options.state;this.setData(this.state.getData())}this.setOptions(options);var element=document.id(element);this.element=element;this.elements={page_total:element.getElement(".page-total"),page_current:element.getElement(".page-current"),page_start:element.getElement(".start a"),page_next:element.getElement(".next a"),page_prev:element.getElement(".prev a"),page_end:element.getElement(".end a"),page_container:element.getElement(".page"),pages:{},limit_box:element.getElement("select")};this.setValues();this.element.addEvent("click:relay(a)",function(e){e.stop();if(e.target.get("data-enabled")=="0"){return}this.fireEvent("clickPage",e.target)}.bind(this));this.elements.limit_box.addEvent("change",function(e){e.stop();this.fireEvent("changeLimit",this.elements.limit_box.get("value"))}.bind(this))},setValues:function(){this.fireEvent("beforeSetValues");var values=this.values,els=this.elements;this.setPageData(els.page_start,{offset:0});this.setPageData(els.page_end,{offset:(values.page_total-1)*values.limit});this.setPageData(els.page_prev,{offset:Math.max(0,(values.page_current-2)*values.limit)});var offset=Math.min((values.page_total-1)*values.limit,values.page_current*values.limit);this.setPageData(els.page_next,{offset:offset});els.page_container.empty();var i=1;while(i<=values.page_total){var el=null;if(i==values.page_current){el=new Element("span",{text:i})}else if(i<3||Math.abs(i-values.page_total)<2||Math.abs(i-values.page_current)<2){el=new Element("a",{href:"#",text:i,"data-limit":values.limit,"data-offset":(i-1)*values.limit})}else if(Math.abs(i-values.page_current)<3){el=new Element("span",{html:"&hellip;"})}if(el){els.pages[i]=el;el.inject(els.page_container)}i++}els.page_current.set("text",values.page_current);els.page_total.set("text",values.page_total);els.limit_box.set("value",values.limit);this.fireEvent("afterSetValues")},setPageData:function(page,data){this.fireEvent("beforeSetPageData",{page:page,data:data});var limit=data.limit||this.values.limit;page.set("data-limit",limit);page.set("data-offset",data.offset);var method=data.offset==this.values.offset?"addClass":"removeClass",wrap=page;if(wrap.getParent()!==this.elements.page_container&&wrap.getParent()!==this.element&&!wrap.getParent().match("ul")){wrap=wrap.getParent();if(wrap.getParent()!==this.elements.page_container&&wrap.getParent()!==this.element&&!wrap.getParent().match("ul")){wrap=wrap.getParent()}}wrap[method]("off disabled");page.set("data-enabled",(data.offset!=this.values.offset)-0);this.fireEvent("afterSetPageData",{page:page,data:data})},setData:function(data){this.fireEvent("beforeSetData",{data:data});var values=this.values;if(data.total==0){values.limit=this.state.get("limit");values.offset=this.state.get("offset");values.total=0;values.page_total=1;values.page_current=1}else{Files.utils.each(data,function(value,key){values[key]=value});values.limit=Math.max(values.limit,1);values.offset=Math.max(values.offset,0);if(values.limit>values.total){values.offset=0}if(!values.limit){values.offset=0;values.limit=values.total}values.page_total=Math.ceil(values.total/values.limit);if(values.offset>values.total){values.offset=(values.page_total-1)*values.limit}values.page_current=Math.floor(values.offset/values.limit)+1}this.fireEvent("afterSetData",{data:data})}});(function(){var updatePathway=function(list,pathway,buffer,width,offset){var index=width-offset,sizes=buffer[index]||buffer.max,last=list.getChildren().length-1;list.getChildren().each(function(folder,index){if(index>0&&index<last){folder.setStyle("width",sizes[index].value);if(sizes[index].value<=48){folder.removeClass("overflow-ellipsis")}else{folder.addClass("overflow-ellipsis")}}})};if(!this.Files)this.Files={};Files.Pathway=new Class({Implements:[Options],element:false,options:{element:"files-pathway",offset:8},initialize:function(options){this.setOptions(options)},setPath:function(app){if(!this.element){this.element=document.id(this.options.element)}this.element.getParent().setStyle("position","relative");var pathway=this.element;pathway.setStyles({overflow:"visible","text-overflow":"ellipsis","white-space":"nowrap",bottom:0,top:0,left:(pathway.getPrevious()?pathway.getPrevious().getSize().x:0)+this.options.offset,right:pathway.getNext().getSize().x+this.options.offset,position:"absolute"});pathway.empty();var list=new Element("ul",{"class":"breadcrumb breadcrumb-resizable"}),wrap=function(app,title,path,icon){var result=new Element("li",{title:title,events:{click:function(){app.navigate(path)}}}),link=new Element("span",{text:title});result.grab(link);if(icon){link.grab(new Element("span",{"class":"divider"}),"top")}return result};var root=wrap(app," "+app.container.title,"",false).getElement("span").grab(new Element("i",{"class":"icon-database icon-hdd"}),"top").getParent();list.adopt(root);var folders=app.getPath().split("/"),path="";folders.each(function(title){if(title.trim()){path+=path?"/"+title:title;list.adopt(wrap(app,title,path,true))}});list.getLast().addClass("active");pathway.setStyle("visibility","hidden");pathway.adopt(list);if(this.pathway){window.removeEvent("resize",this.pathway);this.pathway=false}if(list.getChildren().length>2){var widths={},ceil=0,offset=list.getFirst().getSize().x+list.getLast().getSize().x;list.getChildren().each(function(item,i){if(item.match(":first-child")||item.match(":last-child"))return;var x=item.getSize().x;widths[i]={key:i,value:x};ceil+=x});var buffer={},queue=ceil;buffer[ceil]=buffer.max=widths;while(queue>0){--queue;var max={key:null,value:0},sizelist={};for(var key in widths){if(widths.hasOwnProperty(key)){var item=widths[key];if(item.value>max.value)max=item;sizelist[key]={key:item.key,value:item.value}}}--sizelist[max.key].value;buffer[queue]=sizelist;widths=sizelist}updatePathway(list,pathway,buffer,pathway.getSize().x,offset);pathway.setStyle("visibility","visible");this.pathway=function(){updatePathway(list,pathway,buffer,pathway.getSize().x,offset)};window.addEvent("resize",this.pathway)}else{pathway.setStyle("visibility","visible")}}})})();if(!Files)var Files={};Files.blank_image="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAMAAAAoyzS7AAAABGdBTUEAALGPC/xhBQAAAAd0SU1FB9MICA0xMTLhM9QAAAADUExURf///6fEG8gAAAABdFJOUwBA5thmAAAACXBIWXMAAAsSAAALEgHS3X78AAAACklEQVQIHWNgAAAAAgABz8g15QAAAABJRU5ErkJggg==";Files.App=new Class({Implements:[Events,Options],_tmpl_cache:{},active:null,title:"",cookie:null,options:{cookie:{path:"/"},persistent:true,thumbnails:true,types:null,container:null,active:null,pathway:{element:"files-pathway"},state:{defaults:{}},tree:{enabled:true,element:"#files-tree"},grid:{element:"files-grid",batch_delete:"#files-batch-delete",icon_size:150},paginator:{element:"files-paginator"},folder_dialog:{view:"#files-new-folder-modal",input:"#files-new-folder-input",open_button:"#files-new-folder-toolbar",create_button:"#files-new-folder-create",onOpen:function(){var modal=this._folder_dialog.view,tmp=this._folder_dialog.tmp,handleClose=function(){modal.inject(tmp);
SqueezeBox.removeEvent("close",handleClose)},handleOpen=function(){var focus=modal.getElement("input.focus");if(focus){focus.focus()}SqueezeBox.removeEvent("open",handleOpen)},sizes=modal.measure(function(){return this.getSize()});SqueezeBox.addEvent("close",handleClose);SqueezeBox.addEvent("open",handleOpen);SqueezeBox.open(modal.setStyle("display",""),{handler:"adopt",size:{x:sizes.x,y:sizes.y}})},onClose:function(){SqueezeBox.close()},onInit:function(folder_dialog){var self=this,modal=folder_dialog.view;folder_dialog.tmp=new Element("div",{style:"display:none"}).inject(document.body);folder_dialog.tmp.grab(modal);folder_dialog.open_button.addEvent("click",function(e){e.stop();self.openFolderDialog()});var validate=function(){if(this.value.trim()){folder_dialog.create_button.addClass("valid").removeProperty("disabled")}else{folder_dialog.create_button.removeClass("valid").setProperty("disabled","disabled")}};folder_dialog.input.addEvent("change",validate);if(window.addEventListener){folder_dialog.input.addEventListener("input",validate)}else{folder_dialog.input.addEvent("keyup",validate)}},onSubmit:function(){},onCreate:function(folder_dialog){folder_dialog.input.set("value","");folder_dialog.create_button.removeClass("valid").setProperty("disabled","disabled")}},uploader_dialog:{view:"#files-upload",button:"#files-show-uploader"},history:{enabled:true},router:{defaults:{option:"com_files",view:"files",format:"json"}},initial_response:null,onAfterSetGrid:function(){window.addEvent("resize",function(){this.setDimensions(true)}.bind(this));this.grid.addEvent("onAfterRenew",function(){this.setDimensions(true)}.bind(this));this.addEvent("onUploadFile",function(){this.setDimensions(true)}.bind(this))},onAfterNavigate:function(path){if(path!==undefined){this.setTitle(this.folder.name||this.container.title);jQuery("#upload-files-to, .upload-files-to").text(this.container.title+(path?"/"+path:""))}}},initialize:function(options){this.setOptions(options);if(this.options.persistent&&this.options.container){var container=typeof this.options.container==="string"?this.options.container:this.options.container.slug;this.cookie="com.files.container."+container}if(this.options.pathway){this.setPathway()}this.setState();this.setHistory();this.setGrid();this.setPaginator();var url=this.getUrl();if(url.getData("container")&&!this.options.container){this.options.container=url.getData("container")}if(url.getData("folder")){this.options.active=url.getData("folder")}if(this.options.thumbnails){this.addEvent("afterSelect",function(resp){this.setThumbnails()})}if(this.options.uploader_dialog){this.setUploaderDialog()}if(this.options.container){this.setContainer(this.options.container)}},setState:function(){this.fireEvent("beforeSetState");if(this.cookie){var state=Cookie.read(this.cookie+".state"),obj=JSON.decode(state,true);if(obj){if(!this.getUrl().getData("folder")){this.options.active=obj.folder}delete obj.folder;this.options.state.defaults=Files.utils.merge(this.options.state.defaults,obj)}}var opts=this.options.state;this.state=new Files.State(opts);this.fireEvent("afterSetState")},setHistory:function(){this.fireEvent("beforeSetHistory");if(this.options.history.enabled){var that=this;this.history=History;window.addEvent("popstate",function(e){if(e){e.stop()}var state=History.getState(),old_state=that.state.getData(),new_state=state.data,state_changed=false;Files.utils.each(old_state,function(value,key){if(state_changed===true){return}if(new_state&&new_state[key]&&value!==new_state[key]){state_changed=true}});if(that.container&&(state_changed||that.active!==state.data.folder)){var set_state=Files.utils.append({},state.data);["option","view","layout","folder","container"].each(function(key){delete set_state[key]});that.state.set(set_state);that.navigate(state.data.folder,"stateless")}});this.addEvent("afterNavigate",function(path,type){if(type!=="stateless"&&that.history){var obj={folder:that.active,container:that.container?that.container.slug:null};obj=Files.utils.append(obj,that.state.getData());var method=type==="initial"?"replaceState":"pushState";var url=that.getUrl().setData(obj,true).set("fragment","").toString();that.history[method](obj,null,url)}})}this.fireEvent("afterSetHistory")},navigate:function(path,type,revalidate_cache,response){this.fireEvent("beforeNavigate",[path,type]);if(path!==undefined){if(this.active){this.state.set("offset",0)}this.active=path=="/"?"":path}this.grid.reset();var parts=this.active.split("/"),name=parts[parts.length?parts.length-1:0],folder=parts.slice(0,parts.length-1).join("/"),that=this,url_builder=function(url){if(revalidate_cache){url["revalidate_cache"]=1}return this.createRoute(url)}.bind(this),success=function(resp){if(resp.status!==false){Files.utils.each(resp.entities,function(item){if(!item.baseurl){item.baseurl=that.baseurl}});that.response=resp;that.grid.insertRows(resp.entities);that.fireEvent("afterSelect",resp)}else{alert(resp.error)}};this.folder=new Files.Folder({folder:folder,name:name});if(response){success(response)}else{this.folder.getChildren(success,null,this.state.getData(),url_builder)}if(this.cookie){var data=jQuery.extend(true,{},this.state.data);data.folder=this.active;Cookie.write(this.cookie+".state",JSON.encode(data),this.options.cookie)}this.fireEvent("afterNavigate",[path,type])},setContainer:function(container){var setter=function(item){this.fireEvent("beforeSetContainer",{container:item});this.container=item;this.baseurl=Files.sitebase+"/"+item.relative_path;this.active="";if(this.uploader){if(this.container.parameters.allowed_extensions){this.uploader.settings.filters=[{title:Files._("All Files"),extensions:this.container.parameters.allowed_extensions.join(",")}]}if(this.container.parameters.maximum_size){this.uploader.settings.max_file_size=this.container.parameters.maximum_size;var max_size=document.id("upload-max-size");if(max_size){max_size.set("html",new Files.Filesize(this.container.parameters.maximum_size).humanize())}}}if(this.container.parameters.thumbnails!==true){this.options.thumbnails=false}else{this.state.set("thumbnails",true)}if(this.options.types!==null){this.options.grid.types=this.options.types;this.state.set("types",this.options.types)}if(this.options.folder_dialog){this.setFolderDialog()}this.fireEvent("afterSetContainer",{container:item});this.setTree();this.active=this.options.active||"";this.options.active="";if(typeof this.options.initial_response==="string"){this.options.initial_response=JSON.decode(this.options.initial_response)}this.navigate(this.active,"initial",false,this.options.initial_response)}.bind(this);if(typeof container==="string"){new Request.JSON({url:this.createRoute({view:"container",slug:container,container:false}),method:"get",onSuccess:function(response){setter(response.entities[0])}.bind(this)}).send()}else{setter(container)}},setPaginator:function(){this.fireEvent("beforeSetPaginator");var opts=this.options.paginator,state=this.state;Files.utils.append(opts,{state:state,onClickPage:function(el){this.state.set("limit",el.get("data-limit"));this.state.set("offset",el.get("data-offset"));this.navigate()}.bind(this),onChangeLimit:function(limit){this.state.set("limit",limit);var total=Files.app.paginator.values.total,offset=Files.app.paginator.values.offset;if(total){var page_count=Math.ceil(total/limit);offset=(page_count-1)*limit}this.state.set("offset",offset);this.navigate()}.bind(this)});this.paginator=new Files.Paginator(opts.element,opts);var that=this;that.addEvent("afterSelect",function(response){that.paginator.setData({limit:response.meta.limit,offset:response.meta.offset,total:response.meta.total});that.paginator.setValues()});this.fireEvent("afterSetPaginator")},setGrid:function(){this.fireEvent("beforeSetGrid");var that=this,opts=this.options.grid,key=this.cookie+".grid.layout";if(this.cookie&&Cookie.read(key)){opts.layout=Cookie.read(key)}Files.utils.append(opts,{onClickFolder:function(e){var target=document.id(e.target),node=target.getParent(".files-node-shadow")||target.getParent(".files-node"),path=node.retrieve("row").path;if(path){this.navigate(path)}}.bind(this),onClickImage:function(e){var target=document.id(e.target),node=target.getParent(".files-node-shadow")||target.getParent(".files-node"),row=node.retrieve("row"),img=that.createRoute({view:"file",format:"raw",name:row.name,folder:row.folder});if(img){jQuery.magnificPopup.open({items:{src:img,type:"image"}})}},onClickFile:function(e){var target=document.id(e.target),node=target.getParent(".files-node-shadow")||target.getParent(".files-node"),row=node.retrieve("row"),copy=Files.utils.append({},row);copy.template="file_preview";copy=copy.render();var element=jQuery(copy);element.addClass("mfp-hide koowa");jQuery.magnificPopup.open({items:{src:element,type:"inline"}})},onAfterSetLayout:function(context){if(key){Cookie.write(key,context.layout,this.options.cookie)}}.bind(this)});this.grid=new Files.Grid(this.options.grid.element,opts);this.fireEvent("afterSetGrid")},setTree:function(){this.fireEvent("beforeSetTree");if(this.options.tree.enabled){var opts=this.options.tree,that=this;opts=jQuery.extend(true,{},{onSelectNode:function(node){if(node.id||node.url){that.navigate(node&&node.id?node.id:"")}},root:{text:this.container.title}},opts);this.tree=new Files.Tree(jQuery(opts.element),opts);this.tree.fromUrl(this.createRoute({view:"folders",tree:"1",limit:"0"}));this.addEvent("afterNavigate",function(path){that.tree.selectPath(path)});if(this.grid){this.grid.addEvent("afterDeleteNode",function(context){var node=context.node;if(node.type=="folder"){that.tree.removeNode(node.path)}})}}this.fireEvent("afterSetTree")},setFolderDialog:function(){var self=this;this._folder_dialog={view:document.getElement(this.options.folder_dialog.view),input:document.getElement(this.options.folder_dialog.input),open_button:document.getElement(this.options.folder_dialog.open_button),create_button:document.getElement(this.options.folder_dialog.create_button)};if(this.options.folder_dialog.onInit){this.options.folder_dialog.onInit.call(this,this._folder_dialog)}this._folder_dialog.view.getElement("form").addEvent("submit",function(e){e.stop();if(self.options.folder_dialog.onSubmit){self.options.folder_dialog.onSubmit.call(self,self._folder_dialog)}var element=self._folder_dialog.input;var value=element.get("value").trim();if(value.length>0){var folder=new Files.Folder({name:value,folder:Files.app.getPath()});folder.add(function(response,responseText){if(response.status===false){return alert(response.error)}var el=response.entities[0];var cls=Files[el.type.capitalize()];var row=new cls(el);Files.app.grid.insert(row);Files.app.tree.appendNode({id:row.path,label:row.name});if(self.options.folder_dialog.onCreate){self.options.folder_dialog.onCreate.call(self,self._folder_dialog)}self.closeFolderDialog()})}})},openFolderDialog:function(){if(this.options.folder_dialog){this.options.folder_dialog.onOpen.call(this,this._folder_dialog)}return!!this.options.folder_dialog},closeFolderDialog:function(){if(this.options.folder_dialog){this.options.folder_dialog.onClose.call(this,this._folder_dialog)}return!!this.options.folder_dialog},setUploaderDialog:function(){var self=this;this._tmp_uploader=new Element("div",{style:"display:none"}).inject(document.body);document.getElement(this.options.uploader_dialog.view).getParent().inject(this._tmp_uploader).setStyle("visibility","");document.getElement(this.options.uploader_dialog.button).addEvent("click",function(e){e.stop();self.openUploaderDialog()})},openUploaderDialog:function(){if(this.uploader){var self=this,handleClose=function(){document.getElement(self.options.uploader_dialog.view).getParent().inject(self._tmp_uploader);SqueezeBox.removeEvent("close",handleClose)};SqueezeBox.addEvent("close",handleClose);SqueezeBox.open(document.getElement(self.options.uploader_dialog.view).getParent(),{handler:"adopt",size:{x:700,y:document.getElement(self.options.uploader_dialog.view).getParent().measure(function(){this.setStyle("width",700);var height=this.getSize().y;this.setStyle("width","");return height})}})}return!!this.uploader},closeUploaderDialog:function(){if(this.uploader){SqueezeBox.close()}return!!this.uploader},getUrl:function(){return new URI(window.location.href)},getPath:function(){return this.active},setThumbnails:function(){this.setDimensions(true);var nodes=this.grid.nodes,that=this;if(nodes.getLength()){nodes.each(function(node){if(node.filetype!=="image"){return}var name=node.name;var img=node.element.getElement("img.image-thumbnail");if(img){img.addEvent("load",function(){this.addClass("loaded")});img.set("src",node.thumbnail?node.thumbnail:Files.blank_image);(node.element.getElement(".files-node")||node.element).addClass("loaded").removeClass("loading");if(window.sessionStorage){sessionStorage[node.image.toString()]=img.get("src")}}})}},setDimensions:function(force){if(!this._cached_grid_width)this._cached_grid_width=0;if(this._cached_grid_width!=this.grid.root.element.getSize().x||force){var width=this.grid.root.element.getSize().x,factor=width/(this.grid.options.icon_size.toInt()+40),limit=Math.min(Math.floor(factor),this.grid.nodes.getLength()),resize=width/limit,thumbs=[[]],labels=[[]],index=0,pointer=0;this.grid.root.element.getElements(".files-node-shadow").each(function(element,i,elements){element.setStyle("width",100/limit+"%")},this);this._cached_grid_width=this.grid.root.element.getSize().x}},setPathway:function(){this.fireEvent("beforeSetPathway");var pathway=new Files.Pathway(this.options.pathway);this.addEvent("afterSetTitle",pathway.setPath.bind(pathway,this));this.fireEvent("afterSetPathway")},setTitle:function(title){this.fireEvent("beforeSetTitle",{title:title});this.title=title;this.fireEvent("afterSetTitle",{title:title})},createRoute:function(query){query=Files.utils.merge(this.options.router.defaults,query||{});if(query.container!==false&&!query.container&&this.container){query.container=this.container.slug}else{delete query.container}if(query.format=="html"){delete query.format}return"?"+new Hash(query).filter(function(value,key){return typeof value!=="function"}).toQueryString()}});